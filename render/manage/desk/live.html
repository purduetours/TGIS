<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Master Tour Dashboard | TGIS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], },
                    colors: {
                        'primary-gold': '#CFB991',
                        'text-dark': '#374151',
                        'status-red': '#EF4444',
                        'status-green': '#10B981',
                        'status-purple': '#8B5CF6', 
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f9fafb; color: #1f2937; }
        .glass-header { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); border-bottom: 1px solid #e5e7eb; }
        .card-base { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        input[type="date"]::-webkit-calendar-picker-indicator { cursor: pointer; opacity: 0.6; }
        
        /* Specific state classes for Guide Cards */
        .guide-alert { background-color: #fee2e2 !important; border-color: #ef4444 !important; color: #b91c1c !important; }
        .guide-disabled { background-color: #f3f4f6 !important; border-color: #d1d5db !important; color: #9ca3af !important; opacity: 0.6; }
    </style>
</head>
<body class="font-sans min-h-screen pb-12">

    <header class="glass-header sticky top-0 z-50 px-6 py-4 mb-8">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <p class="text-[10px] font-black text-primary-gold uppercase tracking-[0.2em]">Purdue University</p>
                <h1 class="text-2xl font-black text-text-dark tracking-tighter">MASTER DASHBOARD</h1>
            </div>
            <div class="flex items-center bg-gray-100 px-4 py-2 rounded-2xl border border-gray-200 shadow-sm">
                <span class="text-xs font-bold text-gray-400 uppercase mr-3">Date:</span>
                <input type="date" id="datePicker" onchange="fetchData()" 
                       class="bg-transparent text-sm font-bold text-text-dark outline-none">
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-6">
        
        <section class="grid grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
            <div id="status-930" class="card-base bg-white border-2 border-gray-100 rounded-3xl p-6 text-center shadow-sm">
                <p class="status-label text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1 italic">Checking...</p>
                <h4 class="text-4xl font-black text-gray-300">9:30</h4>
            </div>
            <div id="status-1030" class="card-base bg-white border-2 border-gray-100 rounded-3xl p-6 text-center shadow-sm">
                <p class="status-label text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1 italic">Checking...</p>
                <h4 class="text-4xl font-black text-gray-300">10:30</h4>
            </div>
            <div id="status-130" class="card-base bg-white border-2 border-gray-100 rounded-3xl p-6 text-center shadow-sm">
                <p class="status-label text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1 italic">Checking...</p>
                <h4 class="text-4xl font-black text-gray-300">1:30</h4>
            </div>
            <div id="status-230" class="card-base bg-white border-2 border-gray-100 rounded-3xl p-6 text-center shadow-sm">
                <p class="status-label text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1 italic">Checking...</p>
                <h4 class="text-4xl font-black text-gray-300">2:30</h4>
            </div>
        </section>

        <h3 class="text-lg font-black text-text-dark mb-6 uppercase tracking-tight flex items-center">
            <span class="w-8 h-[2px] bg-primary-gold mr-3"></span>
            Tour Guide Assignments
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100">
                <h4 class="text-sm font-black text-gray-400 uppercase mb-4">9:30 AM Slot</h4>
                <ul id="list-9DV" class="space-y-3"></ul>
            </div>
            <div class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100">
                <h4 class="text-sm font-black text-gray-400 uppercase mb-4">10:30 AM Slot</h4>
                <ul id="list-10DV" class="space-y-3"></ul>
            </div>
            <div class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100">
                <h4 class="text-sm font-black text-gray-400 uppercase mb-4">1:30 PM Slot</h4>
                <ul id="list-1DV" class="space-y-3"></ul>
            </div>
            <div class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100">
                <h4 class="text-sm font-black text-gray-400 uppercase mb-4">2:30 PM Slot</h4>
                <ul id="list-2DV" class="space-y-3"></ul>
            </div>
        </div>
    </main>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw1T8cINZZXSLKCfEF60J4Z4jaAlSuZXbrms6k7wNBabyT0MJmdDwR7FqOPVYbufFrVfA/exec";
        let currentToursData = {};

        document.getElementById('datePicker').value = new Date().toISOString().split('T')[0];

        async function fetchData() {
            const selectedDate = document.getElementById('datePicker').value;
            const finalUrl = `${SCRIPT_URL}?page=master_dashboard&date=${selectedDate}`;
            const slotIds = ['list-9DV', 'list-10DV', 'list-1DV', 'list-2DV'];
            
            slotIds.forEach(id => document.getElementById(id).innerHTML = '<li class="text-gray-400 text-xs animate-pulse">Syncing...</li>');

            try {
                const response = await fetch(finalUrl);
                const data = await response.json();
                currentToursData = data.tours || {};
                renderTours(currentToursData);
                updateStatuses();
            } catch (err) {
                console.error(err);
            }
        }

        function renderTours(tours) {
            const mapping = { '9DV': 'list-9DV', '10DV': 'list-10DV', '1DV': 'list-1DV', '2DV': 'list-2DV' };
            for (let key in mapping) {
                const list = document.getElementById(mapping[key]);
                const names = tours[key] || [];
                
                list.innerHTML = names.length === 0 
                    ? '<li class="text-gray-300 text-xs italic py-2">No assignments</li>'
                    : names.map(name => {
                        let dynamicClass = "bg-gray-50 border-gray-100 text-text-dark";
                        let dotClass = "bg-primary-gold";
                        
                        // Conditionals for formatting based on symbols
                        if (name.includes('*')) {
                            dynamicClass = "guide-alert shadow-md"; 
                            dotClass = "bg-red-600";
                        } else if (name.includes('`')) {
                            dynamicClass = "guide-disabled";
                            dotClass = "bg-gray-400";
                        }

                        return `
                            <li class="flex items-center justify-between p-3 rounded-2xl border font-bold text-sm transition-all ${dynamicClass}">
                                ${name}
                                <span class="w-1.5 h-1.5 rounded-full ${dotClass}"></span>
                            </li>
                        `;
                    }).join('');
            }
        }

        function updateStatuses() {
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();

            const tourTimes = [
                { id: 'status-930', key: '9DV', start: 570, end: 675 },  
                { id: 'status-1030', key: '10DV', start: 630, end: 735 }, 
                { id: 'status-130', key: '1DV', start: 810, end: 915 },  
                { id: 'status-230', key: '2DV', start: 870, end: 975 }   
            ];

            tourTimes.forEach(tour => {
                const el = document.getElementById(tour.id);
                const label = el.querySelector('.status-label');
                const timeText = el.querySelector('h4');
                const isScheduled = currentToursData[tour.key] && currentToursData[tour.key].length > 0;

                if (!isScheduled) {
                    el.className = "card-base bg-status-red/10 border-2 border-status-red/20 rounded-3xl p-6 text-center shadow-sm";
                    timeText.className = "text-4xl font-black text-status-red/40";
                    label.textContent = "NOT SCHEDULED";
                    label.className = "status-label text-[10px] font-black text-status-red uppercase tracking-widest mb-1";
                } else if (currentTime >= tour.start && currentTime <= tour.end) {
                    el.className = "card-base bg-status-green/10 border-2 border-status-green rounded-3xl p-6 text-center shadow-sm";
                    timeText.className = "text-4xl font-black text-status-green";
                    label.textContent = "ON TOUR";
                    label.className = "status-label text-[10px] font-black text-status-green uppercase tracking-widest mb-1";
                } else if (currentTime > tour.end) {
                    el.className = "card-base bg-status-purple/10 border-2 border-status-purple rounded-3xl p-6 text-center shadow-sm";
                    timeText.className = "text-4xl font-black text-status-purple";
                    label.textContent = "RETURNED";
                    label.className = "status-label text-[10px] font-black text-status-purple uppercase tracking-widest mb-1";
                } else {
                    el.className = "card-base bg-white border-2 border-primary-gold/30 rounded-3xl p-6 text-center shadow-sm";
                    timeText.className = "text-4xl font-black text-primary-gold";
                    label.textContent = "UPCOMING";
                    label.className = "status-label text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1";
                }
            });
        }

        fetchData();
        setInterval(updateStatuses, 30000);
        setInterval(fetchData, 300000);
    </script>
</body>
</html>
